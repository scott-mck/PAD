!function(){window.Board=function(t){this.$el=t,this.board=[];for(var o=0;o<10;o++)this.board.push([])},Board.prototype.addOrb=function(t,o){this.board[o[0]][o[1]]=t,t.updatePosition(o),t.addToBoard(this.$el)},Board.prototype.checkForMatch=function(t,o){for(var r,e,s=[t],i=-1,a=1;!e;)"v"===o?r=this.orbAtPosition(t.pos[0]+a*i,t.pos[1]):"h"===o&&(r=this.orbAtPosition(t.pos[0],t.pos[1]+a*i)),r&&r.color===t.color?(s.push(r),a+=1):(i*=-1,a=1,i<0&&(e=!0));return s.length>=3&&new Match(this,s)},Board.prototype.checkMatchConnections=function(t){for(var o=0,r=o+1;o<t.length-1;){var e=t[o],s=t[r];if(!s)break;e.isConnected(s)?(e.merge(s),t.splice(r,1)):(r+=1,r>t.length-1&&(o+=1,r=o+1))}},Board.prototype.clearSkyfallSlots=function(){for(var t=5;t<10;t++)this.board[t].splice(0)},Board.prototype.createSkyfallOrbs=function(t){for(var o=0;o<t.length;o++)for(var r=t[o][1],e=0;e<5;e++){var s=[5+e,r];if(!this.orbAtPosition(s)){var i=new Orb.skyfall;this.addOrb(i,s);break}}},Board.prototype.dropOrb=function(t){t.$el.addClass("gravity"),this.board[t.pos[0]][t.pos[1]]=void 0;var o=[t.pos[0]-1,t.pos[1]];this.board[o[0]][o[1]]=t,t.updatePosition(o)},Board.prototype.ensureNoMatches=function(){for(window.matches=this.getMatches();matches.length>0;){for(var t=0;t<matches.length;t++)matches[t].randomize();matches=this.getMatches()}},Board.prototype.extendMatch=function(t){t.setAsParent();var o=t.orbs[1].pos[0]-t.orbs[0].pos[0]===0;o=o?"v":"h";for(var r=[],e=0;e<t.orbs.length;e++)r.push({orb:t.orbs[e],dirToCheck:o});for(;r.length>0;){var s=r.shift(),i=this.checkForMatch(s.orb,s.dirToCheck);if(i){for(var e=0;e<i.orbs.length;e++){var a=i.orbs[e];if(a!==s.orb&&a.match!==t){var n="h"===s.dirToCheck?"v":"h";r.push({orb:a,dirToCheck:n})}}t.merge(i)}}return t},Board.prototype.getBoardLocation=function(t,o){var r=t.pageY-this.$el.offset().top,e=t.pageX-this.$el.offset().left;if(o){var s=90*~~(r/90),i=s+90,a=90*~~(e/90),n=a+90;if(r-s<5||Math.abs(r-i)<5)return;if(e-a<5||Math.abs(e-n)<5)return}return[4-~~(r/90),~~(e/90)]},Board.prototype.getEmpties=function(){for(var t=[],o=0;o<5;o++)for(var r=0;r<6;r++)this.board[o][r]||t.push([o,r]);return t},Board.prototype.getMatches=function(){this.resetOrbs();for(var t=[],o=0;o<5;o++)for(var r=0;r<6;r++){var e=this.orbAtPosition(o,r);if(!e.match){var s=this.getMatchesForOrb(e);s&&t.push(s)}}return this.checkMatchConnections(t),t},Board.prototype.getMatchesForOrb=function(t){var o=this.checkForMatch(t,"h");return o||(o=this.checkForMatch(t,"v")),!!o&&this.extendMatch(o)},Board.prototype.getOrbsAbovePos=function(t){for(var o=[],r=1;t[0]+r<10;r++){var e=this.board[t[0]+r][t[1]];e&&o.push(e)}return o},Board.prototype.gravity=function(t){for(var o=[],r=0;r<t.length;r++)o=o.concat(this.getOrbsAbovePos(t[r]));for(var e=0;e<o.length;e++)this.dropOrb(o[e]);this.clearSkyfallSlots()},Board.prototype.hideOrbs=function(){for(var t=0;t<5;t++)for(var o=0;o<6;o++)this.orbAtPosition(t,o).hide()},Board.prototype.orbAtPosition=function(t,o){if("Array"===t.constructor.name){if(!this.board[t[0]])return;return this.board[t[0]][t[1]]}if(this.board[t])return this.board[t][o]},Board.prototype.populate=function(){for(var t=0;t<6;t++)for(var o=0;o<5;o++){var r=Orb.random();this.addOrb(r,[o,t])}this.ensureNoMatches()},Board.prototype.removeOrb=function(t){this.board[t.pos[0]][t.pos[1]]=void 0},Board.prototype.resetOrbs=function(){for(var t=0;t<5;t++)for(var o=0;o<6;o++)this.orbAtPosition(t,o).match=void 0},Board.prototype.skyfall=function(){var t=this.getEmpties();this.createSkyfallOrbs(t),setTimeout(function(){this.gravity(t)}.bind(this),100)},Board.prototype.swapOrbs=function(t,o){var r=t.pos,e=o.pos;this.board[r[0]][r[1]]=o,this.board[e[0]][e[1]]=t,t.updatePosition(e),o.updatePosition(r)}}(),function(){window.Game=function(t){this.board=t,t.populate(),this.mouseEventsEnable()},Game.prototype.detectOrbSwap=function(t){if(t&&(this.currentPos[0]!==t[0]||this.currentPos[1]!==t[1])){var o=this.board.orbAtPosition(this.currentPos),r=this.board.orbAtPosition(t);this.board.swapOrbs(o,r),this.currentPos=t}},Game.prototype.hoverOrbContain=function(t){var o=this.board.$el;t.pageX<o.offset().left+45?t.pageX=o.offset().left+45:t.pageX>o.offset().left+o.width()-45&&(t.pageX=o.offset().left+o.width()-45),t.pageY<o.offset().top+45?t.pageY=o.offset().top+45:t.pageY>o.offset().top+o.height()-45&&(t.pageY=o.offset().top+o.height()-45)},Game.prototype.hoverOrbShow=function(t){var o=$(t.target).attr("src");this.$hoverOrb=$('<img class="orb">').attr("src",o),this.$hoverOrb.addClass("hover-orb"),this.hoverOrbUpdate(t),$("body").append(this.$hoverOrb)},Game.prototype.hoverOrbUpdate=function(t){this.hoverOrbContain(t),this.$hoverOrb.css("top",t.pageY-45+"px"),this.$hoverOrb.css("left",t.pageX-45+"px")},Game.prototype.match=function(){var t=this.board.getMatches(),o=t.pop();if(o){o.remove();var r=setInterval(function(){var o=t.pop();o?o.remove():(clearInterval(r),this.skyfall())}.bind(this),500)}},Game.prototype.mousedown=function(t){t.preventDefault(),$(document).on("mousemove",this.mousemove.bind(this)),this.hoverOrbShow(t),this.currentPos=this.board.getBoardLocation(t),this.board.orbAtPosition(this.currentPos).click(),$(document).one("mouseup",this.mouseup.bind(this))},Game.prototype.mouseEventsDisable=function(){this.board.$el.off("mousedown"),$(document).off("mousedown")},Game.prototype.mouseEventsEnable=function(){this.board.$el.on("mousedown",this.mousedown.bind(this))},Game.prototype.mousemove=function(t){this.hoverOrbUpdate(t);var o=this.board.getBoardLocation(t,!0);this.detectOrbSwap(o)},Game.prototype.mouseup=function(){$(document).off("mousemove"),this.$hoverOrb&&this.$hoverOrb.remove(),this.board.orbAtPosition(this.currentPos).release(),this.match()},Game.prototype.skyfall=function(){var t=this.board.getEmpties();this.board.createSkyfallOrbs(t),setTimeout(function(){$(".skyfall").removeClass("skyfall"),this.board.gravity(t),$(".gravity").eq(-1).one("transitionend",function(){$(".gravity").removeClass("gravity"),setTimeout(this.match.bind(this),100)}.bind(this))}.bind(this),100)}}(),function(){window.Match=function(t,o,r){this.board=t,this.orbs=[],o&&(this.color=o[0].color,this.add(o,r))},Match.prototype.add=function(t,o){t&&("Array"===t.constructor.name?this.addOrbs(t,o):"Orb"===t.constructor.name&&this.orbs.indexOf(t)<0&&(this.orbs.push(t),o&&(t.match=this)))},Match.prototype.addOrbs=function(t,o){for(var r=0;r<t.length;r++)this.orbs.indexOf(t[r])<0&&(this.orbs.push(t[r]),o&&(t[r].match=this))},Match.prototype.isConnected=function(t){if(this.color!==t.color)return!1;for(var o=0;o<this.orbs.length;o++)for(var r=0;r<t.orbs.length;r++)if(this.orbsConnectedOrSame(this.orbs[o],t.orbs[r]))return!0},Match.prototype.merge=function(t){for(var o=0;o<t.orbs.length;o++)this.orbs.indexOf(t.orbs[o])<0&&this.add(t.orbs[o],!0)},Match.prototype.orbsConnectedOrSame=function(t,o){if(t.pos[0]===o.pos[0]){if(t.pos[1]===o.pos[1])return!0;if(t.pos[1]+1===o.pos[1]||t.pos[1]-1===o.pos[1])return!0}return t.pos[1]===o.pos[1]&&(t.pos[0]+1===o.pos[0]||t.pos[0]-1===o.pos[0])},Match.prototype.randomize=function(){for(var t=0;t<this.orbs.length;t++)this.orbs[t].randomizeColor()},Match.prototype.remove=function(){this.orbs.forEach(function(t){this.board.removeOrb(t),t.remove()}.bind(this))},Match.prototype.removeOrb=function(t){var o=this.orbs.indexOf(t),r=this.orbs.splice(o,1);r.match=void 0},Match.prototype.setAsParent=function(){for(var t=0;t<this.orbs.length;t++)this.orbs[t].match=this}}(),function(){window.Orb=function t(o){this.imageWidth=90,this.color=o,this.$el=$('<img class="orb">').attr("src",t.colors[this.color])},Orb.colors={r:"http://pad.dawnglare.com/Red.png",b:"http://pad.dawnglare.com/Blue.png",g:"http://pad.dawnglare.com/Green.png",l:"http://pad.dawnglare.com/Light.png",d:"http://pad.dawnglare.com/Dark.png",h:"http://pad.dawnglare.com/Heart.png"},Orb.random=function(){var t=Object.keys(Orb.colors),o=~~(Math.random()*t.length);return new Orb(t[o])},Orb.skyfall=function(){var t=Object.keys(Orb.colors),o=~~(Math.random()*t.length),r=new Orb(t[o]);return r.$el.addClass("skyfall"),r},Orb.prototype.addToBoard=function(t){this.$el.css("bottom",this.imageWidth*this.pos[0]+"px"),this.$el.css("left",this.imageWidth*this.pos[1]+"px"),t.append(this.$el)},Orb.prototype.click=function(){this.$el.attr("id","clicked")},Orb.prototype.hide=function(){this.$el.attr("src","http://nontalk.s3.amazonaws.com/black-circle.png")},Orb.prototype.randomizeColor=function(){var t=Object.keys(Orb.colors),o=~~(Math.random()*t.length);this.color=t[o],this.$el.attr("src",Orb.colors[this.color])},Orb.prototype.release=function(){this.$el.removeAttr("id")},Orb.prototype.remove=function(){this.$el.addClass("matched"),this.$el.one("transitionend",function(){this.$el.remove()}.bind(this))},Orb.prototype.setColor=function(t){t&&Orb.colors[t]?(this.color=t,this.$el.attr("src",Orb.colors[t])):(this.color="hidden",this.$el.attr("src","http://nontalk.s3.amazonaws.com/black-circle.png"))},Orb.prototype.show=function(){this.$el.removeClass("hidden")},Orb.prototype.updatePosition=function(t){this.pos=t,this.$el.css("bottom",this.imageWidth*this.pos[0]+"px"),this.$el.css("left",this.imageWidth*this.pos[1]+"px")}}(),function(){window.Painter=function(t,o){this.$el=t,this.game=o,this.$hoverOrb=$("<img>").addClass("orb hover-orb"),$("body").append(this.$hoverOrb),this.$hoverOrb.hide(),this.mouseEventsEnable()},Painter.keyCodes={8:"backspace",37:!0,38:!0,39:!0,40:!0,66:"b",68:"d",71:"g",72:"h",76:"l",82:"r"},Painter.prototype.apply=function(t){var o=$("textarea").val();this.validText(o)&&this.applyText(o)},Painter.prototype.applyText=function(t,o){o||(o=0);for(var r=0;r<t.length;r++){var e=4-~~(o/6),s=o%6,i=this.game.board.orbAtPosition(e,s);i&&i.setColor(t[r]),o+=1}},Painter.prototype.changeColor=function(t){this.color=$(t.currentTarget).find("img").attr("color"),this.$hoverOrb.attr("src",Orb.colors[this.color])},Painter.prototype.keydown=function(t){if(t.metaKey)return void(90===t.which&&t.preventDefault());var o=Painter.keyCodes[t.keyCode];if("backspace"===o){if(t.currentTarget.selectionStart===t.currentTarget.selectionEnd)return t.currentTarget.selectionStart-=1,void t.preventDefault()}else if(!o)return void t.preventDefault();if(Orb.colors[o]){var r=4-~~(t.currentTarget.selectionStart/6),e=t.currentTarget.selectionStart%6,s=this.game.board.orbAtPosition(r,e);s&&s.setColor(o)}},Painter.prototype.hoverOrbHide=function(t){this.game.mouseEventsEnable(),this.$hoverOrb.hide(),$("body").css("cursor","default"),$(document).off("mousemove"),$("#board").off("click")},Painter.prototype.hoverOrbShow=function(t){this.game.mouseEventsDisable(),this.color=$(t.currentTarget).find("img").attr("color"),this.$hoverOrb.attr("src",Orb.colors[this.color]),this.$hoverOrb.show(),this.hoverOrbUpdate(t),$("body").css("cursor","none"),$(document).mousemove(this.hoverOrbUpdate.bind(this)),$("#board").click(this.paintOrb.bind(this))},Painter.prototype.hoverOrbUpdate=function(t){this.$hoverOrb.css("top",t.pageY-45+"px"),this.$hoverOrb.css("left",t.pageX-45+"px")},Painter.prototype.mouseEventsDisable=function(){$(".orb-paint").off("click"),$("#board").off("click"),$(window).off("mousemove"),$("body").css("cursor","default")},Painter.prototype.mouseEventsEnable=function(){$(".orb-paint").on("click",function(t){$(t.currentTarget).hasClass("selected")?(this.hoverOrbHide(t),$(".orb-paint").removeClass("selected")):(this.hoverOrbShow(t),$(".orb-paint").removeClass("selected"),$(t.currentTarget).addClass("selected"))}.bind(this)),$("textarea").keydown(this.keydown.bind(this)),$("textarea").on("paste",this.paste.bind(this)),$("#apply .button").click(this.apply.bind(this)),$("#apply .button").hover(function(){$("#apply .button.hover").css("opacity",1)},function(){$("#apply .button.hover").css("opacity",0)}),$("#apply .button").mousedown(function(){$("#apply .button.click").css("opacity",1)}),$("#apply .button").mouseup(function(){$("#apply .button.click").css("opacity",0)})},Painter.prototype.paintOrb=function(t){var o=this.game.board.getBoardLocation(t),r=this.game.board.orbAtPosition(o);r.setColor(this.color)},Painter.prototype.paste=function(t){var o=t.originalEvent.clipboardData.getData("text"),r=t.currentTarget.selectionStart;this.validText(o)&&this.applyText(o,r)},Painter.prototype.validText=function(t){for(var o=0;o<t.length;o++)if(!Orb.colors[t[o]])return!1;return!0}}();